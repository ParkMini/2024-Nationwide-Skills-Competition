<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스티커 제작</title>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <style>
        #sticker-area {
            width: 500px;
            height: 300px;
            border: 1px solid black;
            position: relative;
            overflow: hidden;
        }
        .sticker {
            position: absolute;
            cursor: move;
        }
        .sticker canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
        #sticker-palette {
            display: flex;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        #sticker-palette img {
            width: 50px;
            height: 50px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <input type="text" id="username" placeholder="사용자 이름">
    <div id="sticker-area"></div>
    <div>
        <label for="border-width">테두리 굵기:</label>
        <input type="number" id="border-width" min="1" max="50" value="5">
    </div>
    <div id="sticker-palette"></div>
    <button id="download-btn">스티커 다운로드</button>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script>
        $(function() {
            const stickerUrls = [
                './B-Module/제공파일/스티커/sticker1.png',
                './B-Module/제공파일/스티커/sticker2.png',
                './B-Module/제공파일/스티커/sticker3.png',
                './B-Module/제공파일/스티커/sticker4.png',
                './B-Module/제공파일/스티커/sticker5.png',
                './B-Module/제공파일/스티커/sticker6.png',
                './B-Module/제공파일/스티커/sticker7.png',
                './B-Module/제공파일/스티커/sticker8.png',
                './B-Module/제공파일/스티커/sticker9.png',
                './B-Module/제공파일/스티커/sticker10.png'
            ];

            let stickerCount = 0;
            const maxStickers = 5; // 예시로 최대 5개로 설정

            // 스티커 팔레트 생성
            stickerUrls.forEach(url => {
                $('#sticker-palette').append(`<img src="${url}" alt="sticker">`);
            });

            // 스티커 드래그 앤 드롭
            $('#sticker-palette img').draggable({
                helper: 'clone',
                cursor: 'move',
                revert: 'invalid'
            });

            $('#sticker-area').droppable({
                accept: '#sticker-palette img',
                drop: function(event, ui) {
                    if (stickerCount >= maxStickers) {
                        alert("스티커를 더 이상 넣을 수 없습니다.");
                        return;
                    }
                    
                    const $sticker = $('<div class="sticker"><canvas></canvas></div>')
                        .css({
                            left: ui.position.left,
                            top: ui.position.top
                        });

                    $(this).append($sticker);
                    stickerCount++;

                    const img = new Image();
                    img.onload = function() {
                        $sticker.width(img.width);
                        $sticker.height(img.height);
                        drawSticker($sticker, img);
                    };
                    img.src = ui.draggable.attr('src');

                    $sticker.draggable({
                        containment: '#sticker-area',
                        cursor: 'move',
                        stop: function() {
                            drawSticker($sticker, img);
                        }
                    }).resizable({
                        aspectRatio: true,
                        containment: '#sticker-area',
                        handles: 'ne, se, sw, nw',
                        stop: function() {
                            drawSticker($sticker, img);
                        }
                    });

                    $sticker.on('mousedown', function() {
                        $(this).css('z-index', 10).siblings().css('z-index', 1);
                    });
                }
            });

            function drawSticker($sticker, img) {
                const canvas = $sticker.find('canvas')[0];
                const ctx = canvas.getContext('2d');
                const width = $sticker.width();
                const height = $sticker.height();
                const borderWidth = parseInt($('#border-width').val());
                const blackBorderWidth = 2;  // 검은색 외곽선 두께

                canvas.width = width + borderWidth * 2;
                canvas.height = height + borderWidth * 2;

                // 캔버스 중앙에 이미지 그리기
                ctx.drawImage(img, borderWidth, borderWidth, width, height);

                // 이미지 데이터 분석
                const imageData = ctx.getImageData(borderWidth, borderWidth, width, height);
                const data = imageData.data;

                // 흰색 테두리 그리기
                ctx.strokeStyle = 'white';
                ctx.lineWidth = borderWidth * 2;
                drawImageBorder(ctx, data, width, height, borderWidth);

                // 검은색 외곽선 그리기
                ctx.strokeStyle = 'black';
                ctx.lineWidth = blackBorderWidth;
                drawImageBorder(ctx, data, width, height, borderWidth + blackBorderWidth);

                // 원본 이미지 다시 그리기 (테두리 위에)
                ctx.drawImage(img, borderWidth, borderWidth, width, height);
            }

            function drawImageBorder(ctx, data, width, height, offset) {
                ctx.beginPath();
                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        const alpha = data[(y * width + x) * 4 + 3];
                        if (alpha > 0) {
                            if (x === 0 || y === 0 || x === width - 1 || y === height - 1 ||
                                data[((y-1) * width + x) * 4 + 3] === 0 ||
                                data[((y+1) * width + x) * 4 + 3] === 0 ||
                                data[(y * width + x - 1) * 4 + 3] === 0 ||
                                data[(y * width + x + 1) * 4 + 3] === 0) {
                                ctx.moveTo(x + offset, y + offset);
                                ctx.lineTo(x + 1 + offset, y + offset);
                            }
                        }
                    }
                }
                ctx.stroke();
            }

            // 테두리 굵기 변경
            $('#border-width').on('input', function() {
                $('.sticker').each(function() {
                    const $sticker = $(this);
                    const img = new Image();
                    img.onload = function() {
                        drawSticker($sticker, img);
                    };
                    img.src = $sticker.find('canvas')[0].toDataURL();
                });
            });

            // 스티커 삭제
            $(document).on('contextmenu', '.sticker', function(e) {
                e.preventDefault();
                if (confirm('이 스티커를 삭제하시겠습니까?')) {
                    $(this).remove();
                    stickerCount--;
                }
            });

            // 스티커 다운로드
            $('#download-btn').click(function() {
                const username = $('#username').val() || 'sticker';
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const $stickerArea = $('#sticker-area');
                
                canvas.width = $stickerArea.width();
                canvas.height = $stickerArea.height();

                $('.sticker').each(function() {
                    const $sticker = $(this);
                    const stickerCanvas = $sticker.find('canvas')[0];
                    ctx.drawImage(stickerCanvas, $sticker.position().left, $sticker.position().top);
                });

                const link = document.createElement('a');
                link.download = `${username}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        });
    </script>
</body>
</html>